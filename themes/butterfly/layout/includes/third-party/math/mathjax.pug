//- Mathjax 3 - Enhanced Professional Typesetting
- const { tags, enableMenu } = theme.math.mathjax
script.
  (() => {
    const loadMathjax = () => {
      if (!window.MathJax) {
        window.MathJax = {
          // ðŸ’¡ TeX è¾“å…¥é…ç½® - ä¸“ä¸šå­¦æœ¯æŽ’ç‰ˆ
          tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$'], ['\\[', '\\]']],
            processEscapes: true,
            processEnvironments: true,
            tags: '!{tags}',
            // ðŸ’¡ åŠ è½½ AMS æ•°å­¦æ‰©å±•åŒ…ä»¥èŽ·å¾—ä¸“ä¸šæŽ’ç‰ˆ
            packages: {'[+]': ['ams', 'noerrors', 'noundefined']},
            // ðŸ’¡ ä¸“ä¸šæ•°å­¦å®å®šä¹‰
            macros: {
              // æ•°é›†
              R: '\\mathbb{R}',
              N: '\\mathbb{N}',
              Z: '\\mathbb{Z}',
              C: '\\mathbb{C}',
              // å¾®åˆ†
              dd: '\\mathrm{d}',
              pdv: ['\\frac{\\partial #1}{\\partial #2}', 2],
              dv: ['\\frac{\\mathrm{d} #1}{\\mathrm{d} #2}', 2],
              // å‘é‡/çŸ©é˜µ
              bm: ['\\boldsymbol{#1}', 1],
              mat: ['\\mathbf{#1}', 1],
              // æ¦‚çŽ‡
              E: '\\mathbb{E}',
              Var: '\\operatorname{Var}',
              Prob: '\\mathbb{P}'
            }
          },
          // ðŸ’¡ CHTML è¾“å‡ºé…ç½® - ä¼˜åŒ–å­—ä½“å’Œé—´è·
          chtml: {
            scale: 1.05,                    // ç¨å¾®ç¼©å°ï¼Œæ›´ç²¾è‡´
            minScale: 0.5,
            mtextInheritFont: false,        // ä½¿ç”¨ MathJax å­—ä½“
            merrorInheritFont: false,
            mathmlSpacing: false,           // ä½¿ç”¨ TeX é—´è·è§„åˆ™
            skipAttributes: {},
            exFactor: 0.5,
            displayAlign: 'center',
            displayIndent: '0'
          },
          // ðŸ’¡ SVG è¾“å‡ºé…ç½®ï¼ˆå¤‡é€‰ï¼‰
          svg: {
            scale: 1.0,
            minScale: 0.5,
            mtextInheritFont: false,
            merrorInheritFont: false,
            mathmlSpacing: false,
            skipAttributes: {},
            exFactor: 0.5,
            displayAlign: 'center',
            displayIndent: '0',
            fontCache: 'global'
          },
          // ðŸ’¡ é€‰é¡¹é…ç½®
          options: {
            enableMenu: !{enableMenu},
            menuOptions: {
              settings: {
                zoom: 'Click',
                zscale: '200%'
              }
            },
            renderActions: {
              findScript: [10, doc => {
                for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
                  const display = !!node.type.match(/; *mode=display/)
                  const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
                  const text = document.createTextNode('')
                  node.parentNode.replaceChild(text, node)
                  math.start = {node: text, delim: '', n: 0}
                  math.end = {node: text, delim: '', n: 0}
                  doc.math.push(math)
                }
              }, '']
            }
          },
          // ðŸ’¡ å¯åŠ¨é…ç½®
          startup: {
            ready: () => {
              MathJax.startup.defaultReady();
              console.log('ðŸ’¡ MathJax ä¸“ä¸šæŽ’ç‰ˆå·²åŠ è½½');
            }
          }
        }

        const script = document.createElement('script')
        script.src = '!{url_for(theme.asset.mathjax)}'
        script.id = 'MathJax-script'
        script.async = true
        document.head.appendChild(script)
      } else {
        MathJax.startup.document.state(0)
        MathJax.texReset()
        MathJax.typesetPromise()
      }
    }

    btf.addGlobalFn('encrypt', loadMathjax, 'mathjax')
    window.pjax ? loadMathjax() : window.addEventListener('load', loadMathjax)
  })()