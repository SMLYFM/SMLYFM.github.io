name: ðŸš€ Deploy Hexo Blog to GitHub Pages

on:
  push:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸ§¹ Clean Cache
        run: npx hexo clean

      - name: ðŸ—ï¸ Build Static Files
        run: npx hexo generate

      - name: ðŸ” Verify Build Artifacts
        run: |
          echo "### ðŸ“‹ Build Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          # æ£€æŸ¥ sitemap
          if [ -f "public/sitemap.xml" ]; then
            echo "âœ… sitemap.xml exists" >> $GITHUB_STEP_SUMMARY
            echo "   - $(grep -c '<url>' public/sitemap.xml) URLs found" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ sitemap.xml not found" >> $GITHUB_STEP_SUMMARY
          fi
          # æ£€æŸ¥ robots.txt
          if [ -f "public/robots.txt" ]; then
            echo "âœ… robots.txt exists" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ robots.txt not found" >> $GITHUB_STEP_SUMMARY
          fi
          # æ£€æŸ¥ PWA manifest
          if [ -f "public/manifest.json" ]; then
            echo "âœ… manifest.json exists (PWA ready)" >> $GITHUB_STEP_SUMMARY
          fi
          # æ£€æŸ¥ Service Worker
          if [ -f "public/sw.js" ]; then
            echo "âœ… sw.js exists (Offline support)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Total files: $(find public -type f | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Total size: $(du -sh public | cut -f1)" >> $GITHUB_STEP_SUMMARY

      - name: ðŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: main
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'ðŸ¤– Auto deploy from ${{ github.sha }}'
          force_orphan: false

      - name: âœ… Deployment Summary
        run: |
          echo "### ðŸŽ‰ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Website**: https://smlyfm.github.io" >> $GITHUB_STEP_SUMMARY
          echo "â° **Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
