# ============================================
# Nginx é…ç½® - ç”¨äº Docker å®¹å™¨
# ä½œè€…: CJX
# é¡¹ç›®: SMLYFM.github.io
# ============================================

# ğŸ’¡ è‡ªåŠ¨æ£€æµ‹ CPU æ ¸å¿ƒæ•°
worker_processes auto;

error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    # ğŸ’¡ æ¯ä¸ª worker çš„æœ€å¤§è¿æ¥æ•°
    worker_connections 1024;
    # ğŸ’¡ ä½¿ç”¨ epoll æé«˜ Linux æ€§èƒ½
    use epoll;
    multi_accept on;
}

http {
    # åŸºç¡€é…ç½®
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # ğŸ’¡ æ—¥å¿—æ ¼å¼ï¼šåŒ…å«å“åº”æ—¶é—´
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'rt=$request_time';
    
    access_log /var/log/nginx/access.log main;
    
    # æ€§èƒ½ä¼˜åŒ–
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    
    # ============================================
    # Gzip å‹ç¼©é…ç½®
    # ============================================
    gzip on;
    gzip_vary on;
    gzip_min_length 1000;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_buffers 16 8k;
    gzip_http_version 1.1;
    gzip_types 
        text/plain 
        text/css 
        application/json 
        application/javascript 
        text/xml 
        application/xml 
        application/xml+rss 
        text/javascript
        image/svg+xml
        application/font-woff
        application/font-woff2;
    
    # ============================================
    # å®‰å…¨å¤´é…ç½® (å¢å¼ºç‰ˆ)
    # ============================================
    # ğŸ’¡ é˜²æ­¢ç‚¹å‡»åŠ«æŒ
    add_header X-Frame-Options "SAMEORIGIN" always;
    # ğŸ’¡ é˜²æ­¢ MIME ç±»å‹å—…æ¢
    add_header X-Content-Type-Options "nosniff" always;
    # ğŸ’¡ XSS é˜²æŠ¤ï¼ˆç°ä»£æµè§ˆå™¨å·²å†…ç½®ï¼Œä½†ä¿ç•™å…¼å®¹æ—§æµè§ˆå™¨ï¼‰
    add_header X-XSS-Protection "1; mode=block" always;
    # ğŸ’¡ å¼•ç”¨ç­–ç•¥
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # ğŸ’¡ HSTS - å¼ºåˆ¶ HTTPSï¼ˆé¢„åŠ è½½åˆ—è¡¨å°±ç»ªï¼‰
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    
    # ğŸ’¡ æƒé™ç­–ç•¥ - é™åˆ¶æµè§ˆå™¨åŠŸèƒ½
    add_header Permissions-Policy "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()" always;
    
    # ğŸ’¡ CSP - å†…å®¹å®‰å…¨ç­–ç•¥ï¼ˆåšå®¢å‹å¥½ç‰ˆæœ¬ï¼‰
    # å…è®¸: åŒæºèµ„æºã€jsDelivr CDNã€Google Fontsã€å¸¸ç”¨åˆ†æè„šæœ¬
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' cdn.jsdelivr.net unpkg.com www.googletagmanager.com www.google-analytics.com; style-src 'self' 'unsafe-inline' cdn.jsdelivr.net fonts.googleapis.com; font-src 'self' fonts.gstatic.com cdn.jsdelivr.net; img-src 'self' data: blob: https: *; connect-src 'self' www.google-analytics.com; frame-src 'self' player.bilibili.com www.youtube.com; media-src 'self';" always;
    
    # ============================================
    # ä¸»æœåŠ¡å™¨é…ç½®
    # ============================================
    server {
        listen 80;
        server_name localhost;
        
        root /usr/share/nginx/html;
        index index.html index.htm;
        
        # å­—ç¬¦é›†
        charset utf-8;
        
        # ============================================
        # é™æ€èµ„æºç¼“å­˜ç­–ç•¥
        # ============================================
        
        # ğŸ’¡ CSS/JS æ–‡ä»¶ï¼šé•¿æœŸç¼“å­˜ï¼ˆ30å¤©ï¼‰
        location ~* \.(css|js)$ {
            expires 30d;
            add_header Cache-Control "public, immutable";
            access_log off;
        }
        
        # ğŸ’¡ å›¾ç‰‡/å­—ä½“ï¼šé•¿æœŸç¼“å­˜ï¼ˆ30å¤©ï¼‰
        location ~* \.(png|jpg|jpeg|gif|ico|svg|webp|woff|woff2|ttf|eot)$ {
            expires 30d;
            add_header Cache-Control "public, immutable";
            access_log off;
        }
        
        # ğŸ’¡ HTML æ–‡ä»¶ï¼šçŸ­æœŸç¼“å­˜ï¼ˆ1å°æ—¶ï¼‰
        location ~* \.html$ {
            expires 1h;
            add_header Cache-Control "public, must-revalidate";
        }
        
        # ============================================
        # ä¸»è·¯ç”±
        # ============================================
        location / {
            try_files $uri $uri/ $uri.html =404;
        }
        
        # ============================================
        # é”™è¯¯é¡µé¢
        # ============================================
        error_page 404 /404.html;
        location = /404.html {
            internal;
        }
        
        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            internal;
        }
        
        # ============================================
        # å¥åº·æ£€æŸ¥ç«¯ç‚¹
        # ============================================
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
}
